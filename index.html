<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Traffic Jam Simulation - Audience Friendly</title>
<style>
  body { background: #222; color: white; font-family: sans-serif; text-align: center; }
  canvas { background: #555; display: block; margin: 20px auto; border: 2px solid #888; }
  .controls { margin: 10px; }
  label { margin-right: 10px; }
</style>
</head>
<body>
<h2>Phantom Traffic Jam Simulation</h2>

<div class="controls">
  <label>Number of Cars: <span id="numCarsVal">80</span></label>
  <input type="range" id="numCars" min="20" max="150" value="80">
  <label>Reaction Time (Ï„): <span id="tauVal">1.2</span>s</label>
  <input type="range" id="tau" min="0.5" max="3" step="0.1" value="1.2">
</div>

<canvas id="trafficCanvas" width="1000" height="400"></canvas>

<script>
const canvas = document.getElementById('trafficCanvas');
const ctx = canvas.getContext('2d');

// ==============================
// PARAMETERS
// ==============================
let L = 1000;       // road length in meters
let N = 80;         // number of cars
let dt = 0.1;       // time step (s)
let T = 10000;      // large enough for animation
let P_max = 0.25;   // max density
let C = 25;         // speed scaling constant
let tau = 1.2;      // reaction time
const noise = 0.05;

// ==============================
// INITIAL CONDITIONS
// ==============================
let x = Array.from({length: N}, (_, i) => i * (L / N));
let v = Array(N).fill(15);
let delaySteps = Math.ceil(tau / dt);
let vDesiredHistory = Array.from({length: delaySteps}, () => Array(N).fill(15));

// ==============================
// UI CONTROLS
// ==============================
const numCarsSlider = document.getElementById('numCars');
const numCarsVal = document.getElementById('numCarsVal');
const tauSlider = document.getElementById('tau');
const tauVal = document.getElementById('tauVal');

numCarsSlider.addEventListener('input', () => {
    N = parseInt(numCarsSlider.value);
    numCarsVal.textContent = N;
    resetSimulation();
});
tauSlider.addEventListener('input', () => {
    tau = parseFloat(tauSlider.value);
    tauVal.textContent = tau;
    delaySteps = Math.ceil(tau / dt);
    vDesiredHistory = Array.from({length: delaySteps}, () => Array(N).fill(15));
});

// ==============================
// RESET FUNCTION
// ==============================
function resetSimulation() {
    x = Array.from({length: N}, (_, i) => i * (L / N));
    v = Array(N).fill(15);
    delaySteps = Math.ceil(tau / dt);
    vDesiredHistory = Array.from({length: delaySteps}, () => Array(N).fill(15));
}

// ==============================
// SIMULATION LOOP
// ==============================
let step = 0;
function simulate() {
    // --- local density ---
    let gaps = x.map((xi, i) => {
        let gap = x[(i+1)%N] - xi;
        if (gap <= 0) gap += L;
        return gap;
    });
    let rho = gaps.map(g => 1 / g);

    // --- desired speed ---
    let vDesired = rho.map(r => Math.max(0, Math.min(40, C * Math.log(P_max / r))));

    // --- delay buffer ---
    vDesiredHistory.shift();
    vDesiredHistory.push(vDesired);

    let vDelayed = vDesiredHistory[0];

    // --- acceleration & noise ---
    let a = v.map((vi, i) => (vDelayed[i] - vi)/tau + noise*(Math.random()-0.5));

    // --- update velocity & position ---
    v = v.map((vi, i) => Math.max(0, vi + a[i]*dt));
    x = x.map((xi, i) => (xi + v[i]*dt) % L);

    draw();
    requestAnimationFrame(simulate);
}

// ==============================
// DRAWING FUNCTION
// ==============================
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // draw road
    ctx.fillStyle = '#444';
    ctx.fillRect(0, canvas.height/2 - 50, canvas.width, 100);

    // scale for position
    const scaleX = canvas.width / L;

    // draw cars
    for(let i=0;i<N;i++){
        // map speed to color: slow=red, fast=green
        let speed = v[i];
        let color;
        if(speed < 10) color = 'red';
        else if(speed < 20) color = 'orange';
        else if(speed < 30) color = 'yellow';
        else color = 'green';

        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x[i]*scaleX, canvas.height/2, 6, 0, 2*Math.PI);
        ctx.fill();
    }

    // draw info
    ctx.fillStyle = 'white';
    ctx.font = '16px sans-serif';
    let avgSpeed = (v.reduce((a,b)=>a+b,0)/v.length).toFixed(1);
    let density = (N/L).toFixed(2);
    ctx.fillText(`Average Speed: ${avgSpeed} m/s | Density: ${density} cars/m`, 10, 20);
}

// ==============================
// START SIMULATION
// ==============================
simulate();
</script>
</body>
</html>

